#!/usr/bin/env node

/**
 * Setup Build Environment Script
 *
 * This script prepares the frontend environment variables for building.
 * It reads the unified .env file and maps environment-specific variables
 * to REACT_APP_ prefixed variables based on APP_ENV.
 *
 * Usage:
 *   node scripts/setup-build-env.js
 *   APP_ENV=production node scripts/setup-build-env.js
 */

const fs = require('fs');
const path = require('path');

// Simple .env parser (no dependencies needed)
function parseEnvFile(filePath) {
  const envConfig = {};
  const fileContent = fs.readFileSync(filePath, 'utf8');

  fileContent.split('\n').forEach(line => {
    // Skip comments and empty lines
    line = line.trim();
    if (!line || line.startsWith('#')) return;

    // Parse KEY=VALUE
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
      const key = match[1].trim();
      let value = match[2].trim();

      // Remove quotes if present
      if ((value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }

      envConfig[key] = value;
    }
  });

  return envConfig;
}

// Determine environment
const APP_ENV = process.env.APP_ENV || 'development';
const isDev = APP_ENV === 'development';

console.log(`\nðŸ”§ Setting up frontend environment for: ${APP_ENV}\n`);

// Load root .env file
const rootEnvPath = path.resolve(__dirname, '../.env');
if (!fs.existsSync(rootEnvPath)) {
  console.error('âŒ Error: .env file not found at root directory');
  console.error('   Please copy .env.example to .env and configure it');
  process.exit(1);
}

const envConfig = parseEnvFile(rootEnvPath);

// Map environment-specific variables to REACT_APP_ variables
const prefix = isDev ? 'DEV_' : 'PROD_';
const mappings = {
  [`${prefix}SUPABASE_URL`]: 'REACT_APP_SUPABASE_URL',
  [`${prefix}SUPABASE_ANON_KEY`]: 'REACT_APP_SUPABASE_ANON_KEY',
  [`${prefix}FRONTEND_URL`]: 'REACT_APP_FRONTEND_URL',
};

// Additional direct mappings (variables that don't have DEV_/PROD_ prefix)
const directMappings = {
  'REACT_APP_API_URL': 'REACT_APP_API_URL',
  'REACT_APP_ENABLE_ANALYTICS': 'REACT_APP_ENABLE_ANALYTICS',
  'REACT_APP_ENABLE_SOCIAL_LOGIN': 'REACT_APP_ENABLE_SOCIAL_LOGIN',
  'REACT_APP_DEBUG': 'REACT_APP_DEBUG',
};

// Build the REACT_APP environment variables
const reactEnvVars = {
  REACT_APP_ENV: APP_ENV,
  REACT_APP_ENVIRONMENT: APP_ENV,
};

// Map environment-specific variables
Object.entries(mappings).forEach(([sourceKey, targetKey]) => {
  if (envConfig[sourceKey]) {
    reactEnvVars[targetKey] = envConfig[sourceKey];
    console.log(`âœ“ Mapped ${sourceKey} â†’ ${targetKey}`);
  } else {
    console.warn(`âš  Warning: ${sourceKey} not found in .env`);
  }
});

// Map direct variables
Object.entries(directMappings).forEach(([sourceKey, targetKey]) => {
  if (envConfig[sourceKey]) {
    reactEnvVars[targetKey] = envConfig[sourceKey];
    console.log(`âœ“ Mapped ${sourceKey} â†’ ${targetKey}`);
  }
});

// Validate required variables
const requiredVars = ['REACT_APP_SUPABASE_URL', 'REACT_APP_SUPABASE_ANON_KEY'];
const missingVars = requiredVars.filter(key => !reactEnvVars[key]);

if (missingVars.length > 0) {
  console.error('\nâŒ Error: Missing required environment variables:');
  missingVars.forEach(key => {
    const sourceKey = key.replace('REACT_APP_SUPABASE', `${prefix}SUPABASE`);
    console.error(`   â€¢ ${sourceKey} (needed for ${key})`);
  });
  console.error('\nPlease configure these variables in your .env file');
  process.exit(1);
}

// Write to frontend/.env.local
const frontendEnvPath = path.resolve(__dirname, '../frontend/.env.local');
const envContent = Object.entries(reactEnvVars)
  .map(([key, value]) => `${key}=${value}`)
  .join('\n');

fs.writeFileSync(frontendEnvPath, `# Auto-generated by setup-build-env.js
# DO NOT EDIT MANUALLY - Changes will be overwritten
# Last generated: ${new Date().toISOString()}
# Environment: ${APP_ENV}

${envContent}
`);

console.log(`\nâœ… Frontend environment configured successfully`);
console.log(`   â€¢ Environment: ${APP_ENV}`);
console.log(`   â€¢ Config written to: frontend/.env.local`);
console.log(`   â€¢ Variables: ${Object.keys(reactEnvVars).length} mapped\n`);
