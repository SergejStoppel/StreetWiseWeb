### **Phase 5: Production Resilience & Scalability**

#### **Issue #5.2: Implement Multi-Region Asset Storage & CDN**

- **Problem:** Storing analysis assets (HTML, CSS, screenshots) in a single region creates latency for global users and potential compliance issues. Additionally, fetching these assets directly from Supabase Storage doesn't scale well.
- **Goal/Benefit:** To provide fast, globally distributed access to analysis assets while maintaining data residency compliance and reducing storage costs through intelligent lifecycle management.
- **Acceptance Requirements:**
    - [ ] CDN integration (CloudFlare/Fastly) is implemented for all analysis assets.
    - [ ] Assets are automatically replicated to at least 2 regions (US, EU) based on workspace location.
    - [ ] Workspace settings include `data_region` field for compliance requirements.
    - [ ] Asset URLs are signed with expiration (24-48 hours) to prevent unauthorized access.
    - [ ] Intelligent lifecycle policy deletes assets after 30 days (configurable per plan).
    - [ ] Workspace-based access control ensures assets are only accessible to authorized members.
    - [ ] Fallback mechanism serves assets from origin if CDN fails.
    - [ ] **Tests:** Integration tests verify CDN caching headers, multi-region replication, and workspace access control. Performance tests confirm <100ms asset delivery globally.
- **Implementation Details:**
    ```typescript
    // Example CDN configuration
    interface AssetStorageConfig {
      regions: {
        primary: 'us-east-1',
        replicas: ['eu-west-1', 'ap-southeast-1']
      },
      cdn: {
        provider: 'cloudflare',
        ttl: 86400, // 24 hours
        customDomain: 'assets.sitecraft.com'
      },
      lifecycle: {
        free: { retentionDays: 7 },
        premium: { retentionDays: 30 },
        enterprise: { retentionDays: 90 }
      }
    }
    
    // Workspace-aware asset URL generation
    function generateAssetUrl(assetPath: string, workspaceId: string): string {
      const region = getWorkspaceRegion(workspaceId);
      const signedUrl = generateSignedUrl(assetPath, { 
        expiresIn: '48h',
        allowedWorkspace: workspaceId 
      });
      return `https://${region}.assets.sitecraft.com/${signedUrl}`;
    }
    ```
    - Use Supabase Storage hooks to trigger CDN cache invalidation on updates.
    - Implement storage cost optimization by compressing HTML/CSS before storage.
    - Consider using Supabase Edge Functions for on-the-fly image optimization.
    - Track asset access patterns to optimize CDN distribution.
    - Ensure GDPR compliance by respecting data residency requirements per workspace.