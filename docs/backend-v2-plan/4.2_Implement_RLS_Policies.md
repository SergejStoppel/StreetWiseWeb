### **Phase 4: Finalization & Auditing**

#### **Issue #4.2: Implement Row-Level Security (RLS) Policies**

- **Problem:** While the API is protected by middleware, the database itself should be the ultimate line of defense, ensuring that users can never access data they don't own, even if there's a bug in the backend code.
- **Goal/Benefit:** To create a highly secure multi-tenant system by enforcing data access rules at the database level, making it impossible for one workspace's data to leak to another.
- **Acceptance Requirements:**
    - [ ] A new SQL migration file (`002_rls_policies.sql`) is created.
    - [ ] RLS is enabled on all tables containing user or workspace-specific data.
    - [ ] Policies are written to enforce the following rules:
        - Users can only select/update/delete their own workspaces or workspaces they are a member of
        - Data linked to a workspace (websites, analyses, issues) can only be accessed by members of that workspace
        - Billing information (subscriptions, report_credits) is strictly tied to the workspace
        - Analysis jobs can only be accessed by the workspace that initiated them
        - Audit logs are read-only and workspace-scoped for non-admins
    - [ ] Service role bypass policies allow background workers to access necessary data.
    - [ ] Policies handle soft deletes properly (don't expose deleted records).
    - [ ] Performance impact is measured and optimized with proper indexes.
    - [ ] **Tests:** A new suite of integration tests is created specifically for RLS. These tests will use one user's credentials to attempt to access data belonging to another user, and assert that the requests fail with a database-level permission error.
- **Implementation Details:**
    - The backend will need to use the user's JWT to authenticate its requests to Supabase, not a master service role key, for RLS to work correctly.
    - Example RLS policies:
        ```sql
        -- Enable RLS on all relevant tables
        ALTER TABLE workspaces ENABLE ROW LEVEL SECURITY;
        ALTER TABLE websites ENABLE ROW LEVEL SECURITY;
        ALTER TABLE analyses ENABLE ROW LEVEL SECURITY;
        ALTER TABLE accessibility_issues ENABLE ROW LEVEL SECURITY;
        ALTER TABLE seo_issues ENABLE ROW LEVEL SECURITY;
        ALTER TABLE performance_issues ENABLE ROW LEVEL SECURITY;
        ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
        ALTER TABLE report_credits ENABLE ROW LEVEL SECURITY;
        ALTER TABLE analysis_jobs ENABLE ROW LEVEL SECURITY;
        ALTER TABLE audit_log ENABLE ROW LEVEL SECURITY;
        
        -- Workspace policies
        CREATE POLICY "Users can view their workspaces" ON workspaces
          FOR SELECT USING (
            EXISTS (
              SELECT 1 FROM workspace_members 
              WHERE workspace_id = workspaces.id 
              AND user_id = auth.uid()
            )
          );
        
        -- Websites policies  
        CREATE POLICY "Workspace members can manage websites" ON websites
          FOR ALL USING (
            EXISTS (
              SELECT 1 FROM workspace_members
              WHERE workspace_id = websites.workspace_id
              AND user_id = auth.uid()
            )
          );
        
        -- Analysis policies with cascading access
        CREATE POLICY "Workspace members can view analyses" ON analyses
          FOR SELECT USING (
            EXISTS (
              SELECT 1 FROM websites w
              JOIN workspace_members wm ON wm.workspace_id = w.workspace_id
              WHERE w.id = analyses.website_id
              AND wm.user_id = auth.uid()
            )
          );
        
        -- Billing policies (more restrictive)
        CREATE POLICY "Only workspace admins can view billing" ON subscriptions
          FOR SELECT USING (
            EXISTS (
              SELECT 1 FROM workspace_members
              WHERE workspace_id = subscriptions.workspace_id
              AND user_id = auth.uid()
              AND role IN ('owner', 'admin')
            )
          );
        
        -- Service role bypass for workers
        CREATE POLICY "Service role bypass" ON analyses
          FOR ALL USING (auth.jwt() ->> 'role' = 'service_role');
        
        -- Audit log policies (read-only for users)
        CREATE POLICY "Users can view their workspace audit logs" ON audit_log
          FOR SELECT USING (
            workspace_id IN (
              SELECT workspace_id FROM workspace_members
              WHERE user_id = auth.uid()
            )
          );
        ```
    - Create composite indexes to optimize RLS policy checks.
    - Document which operations require service role vs user authentication.
    - Implement RLS policy testing in CI/CD pipeline.