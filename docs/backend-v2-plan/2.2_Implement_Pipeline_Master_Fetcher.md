### **Phase 2: The Modular Analysis Engine**

#### **Issue #2.2: Implement Analysis Pipeline (Master & Fetcher Workers)**

- **Problem:** We need a system to orchestrate the analysis and, crucially, to fetch the website's content once and only once for all subsequent steps.
- **Goal/Benefit:** An efficient and robust pipeline foundation that separates content fetching from content analysis, ensuring consistency and reducing redundant network requests.
- **Acceptance Requirements:**
    - [ ] The `POST /api/analyses` endpoint validates workspace access and enqueues a "master analysis" job with workspace context.
    - [ ] The `master.worker.ts` is created. Its first action is to enqueue a "fetcher" job.
    - [ ] A new `fetcher.worker.ts` is created.
    - [ ] The fetcher worker uses Puppeteer to save the HTML, CSS, `robots.txt`, and screenshots to a workspace-scoped folder in Supabase Storage (e.g., `/analysis-assets/{workspace_id}/{analysis_id}/`).
    - [ ] The fetcher worker creates the necessary records in the `screenshots` table with proper workspace_id reference.
    - [ ] Asset storage paths include workspace_id for proper multi-tenant isolation.
    - [ ] Only upon successful completion of the fetcher job does the master worker proceed to enqueue all the specialized analyzer jobs in parallel.
    - [ ] All jobs include workspace_id in their data payload for access control validation.
    - [ ] **Tests:** Integration test for the API endpoint verifying workspace access control. Unit test for the fetcher worker, mocking Puppeteer and Storage calls to ensure assets are saved to the correct workspace-scoped path.
- **Implementation Details:**
    - The path to the saved assets in storage will be passed as part of the job data to the analyzer workers.
    - The master worker should update the main `analyses` record status to `'processing'` and the fetcher job should update its `analysis_jobs` record to `'completed'` or `'failed'`.
    - Example job data structure for multi-tenant isolation:
        ```typescript
        interface AnalysisJobData {
          analysisId: string;
          workspaceId: string;
          websiteId: string;
          assetPath: string; // e.g., /analysis-assets/{workspace_id}/{analysis_id}/
          userId: string; // User who initiated the analysis
        }
        ```
    - All workers must validate that the analysis belongs to the workspace before processing.
    - Use Row Level Security (RLS) policies to ensure workers can only access their workspace's data.