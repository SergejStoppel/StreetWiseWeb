### **Phase 3: Billing & Reporting**

#### **Issue #3.1: Implement Subscription Management & Webhooks**

- **Problem:** We need a way for users to subscribe to paid plans and for our application to react to billing events from Stripe.
- **Goal/Benefit:** A fully functional subscription system that unlocks premium features for paying customers while maintaining proper workspace isolation in our multi-tenant architecture.
- **Acceptance Requirements:**
    - [ ] API endpoints are created for creating a Stripe Checkout session for a subscription (`POST /api/workspaces/:id/subscription/checkout`).
    - [ ] Workspace access validation ensures users can only create subscriptions for their workspaces.
    - [ ] A public webhook endpoint (`/api/stripe/webhooks`) is created to listen for events from Stripe.
    - [ ] The webhook handler correctly processes `checkout.session.completed` to create a new subscriptions record linked to the workspace.
    - [ ] The webhook handler processes `customer.subscription.updated` and `customer.subscription.deleted` to update the status in our subscriptions table.
    - [ ] Subscription changes trigger plan limit updates (analyses per month, concurrent analyses, etc.).
    - [ ] Grace period handling for failed payments (7 days before downgrade).
    - [ ] Proration logic handles mid-cycle plan changes correctly.
    - [ ] **Tests:** Integration tests are written for the checkout API endpoint with workspace validation. Unit tests are written for the webhook handler, providing mock Stripe event payloads and verifying the database is updated correctly.
- **Implementation Details:**
    - Install the `stripe` Node.js library.
    - Use the `stripe.webhooks.constructEvent` method to securely verify webhook signatures.
    - Store the Stripe API key and webhook signing secret in environment variables.
    - Example webhook handler with multi-tenant context:
        ```typescript
        async function handleCheckoutCompleted(session: Stripe.Checkout.Session) {
          const { workspace_id } = session.metadata; // Pass workspace_id in checkout metadata
          
          // Create subscription record
          await supabase.from('subscriptions').insert({
            workspace_id,
            stripe_customer_id: session.customer,
            stripe_subscription_id: session.subscription,
            plan_id: session.metadata.plan_id,
            status: 'active',
            current_period_start: new Date(session.subscription.current_period_start * 1000),
            current_period_end: new Date(session.subscription.current_period_end * 1000)
          });
          
          // Update workspace limits based on plan
          await updateWorkspaceLimits(workspace_id, session.metadata.plan_id);
        }
        ```
    - Implement idempotency to handle Stripe webhook retries.
    - Add webhook event logging to audit_log table for debugging.
    - Configure Stripe customer portal for self-service subscription management.