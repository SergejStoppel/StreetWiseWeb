### **Phase 3: Billing & Reporting**

#### **Issue #3.2: Implement One-Time Purchase & Credit System**

- **Problem:** Users without a subscription need a way to purchase and use single detailed reports.
- **Goal/Benefit:** To create an additional revenue stream and provide a lower-commitment option for users while maintaining workspace-based credit management.
- **Acceptance Requirements:**
    - [ ] An API endpoint is created to initiate a Stripe Checkout session for one-time credit purchases (`POST /api/workspaces/:id/credits/purchase`).
    - [ ] Credit packages are defined (1 credit = $9.99, 5 credits = $39.99, 10 credits = $69.99).
    - [ ] Workspace validation ensures users can only purchase credits for their workspaces.
    - [ ] The Stripe webhook handler is updated to process the `checkout.session.completed` event for one-time purchases.
    - [ ] On successful purchase, a record is created in `one_time_purchases` with workspace context.
    - [ ] The balance in the `report_credits` table for the corresponding workspace is correctly incremented.
    - [ ] Credits never expire and are tied to the workspace (not individual users).
    - [ ] A `GET /api/workspaces/:id/credits/balance` endpoint returns current credit balance.
    - [ ] Database transaction ensures atomic credit increment (no race conditions).
    - [ ] **Tests:** Integration tests are written for the one-time purchase checkout flow with workspace validation. Unit tests for the webhook handler verify that both `one_time_purchases` and `report_credits` are updated atomically.
- **Implementation Details:**
    - Use Stripe's `mode: 'payment'` for one-time purchases, as opposed to `mode: 'subscription'`.
    - Example credit purchase implementation:
        ```typescript
        async function createCreditPurchaseSession(workspaceId: string, creditPackage: string) {
          const packages = {
            'single': { credits: 1, price: 999 },    // $9.99
            'starter': { credits: 5, price: 3999 },  // $39.99
            'value': { credits: 10, price: 6999 }    // $69.99
          };
          
          const session = await stripe.checkout.sessions.create({
            mode: 'payment',
            payment_method_types: ['card'],
            line_items: [{
              price_data: {
                currency: 'usd',
                product_data: {
                  name: `${packages[creditPackage].credits} Analysis Credits`,
                  description: 'Detailed accessibility report credits'
                },
                unit_amount: packages[creditPackage].price,
              },
              quantity: 1,
            }],
            metadata: {
              workspace_id: workspaceId,
              credit_amount: packages[creditPackage].credits,
              purchase_type: 'credits'
            },
            success_url: `${process.env.FRONTEND_URL}/workspace/${workspaceId}/credits?success=true`,
            cancel_url: `${process.env.FRONTEND_URL}/workspace/${workspaceId}/credits?canceled=true`,
          });
          
          return session;
        }
        ```
    - The logic for updating `report_credits` should handle the case where a row doesn't exist yet:
        ```sql
        INSERT INTO report_credits (workspace_id, balance, last_purchased_at)
        VALUES ($1, $2, NOW())
        ON CONFLICT (workspace_id) 
        DO UPDATE SET 
          balance = report_credits.balance + EXCLUDED.balance,
          last_purchased_at = NOW();
        ```
    - Implement credit transfer restrictions (credits cannot be moved between workspaces).
    - Add credit usage tracking in `audit_log` for accountability.