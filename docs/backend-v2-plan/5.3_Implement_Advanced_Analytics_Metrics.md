### **Phase 5: Production Resilience & Scalability**

#### **Issue #5.3: Implement Advanced Analytics & Metrics**

- **Problem:** Without comprehensive metrics, we're flying blind. We need visibility into system performance, user behavior, and business metrics to make informed decisions and ensure system health.
- **Goal/Benefit:** To create a complete observability platform that provides real-time insights into system health, usage patterns, and business KPIs while respecting workspace boundaries in our multi-tenant architecture.
- **Acceptance Requirements:**
    - [ ] Time-series metrics database (InfluxDB or TimescaleDB) is deployed and configured.
    - [ ] System metrics are collected: API response times, worker queue depths, job processing times, error rates.
    - [ ] Business metrics are tracked: analyses per workspace, credit consumption, feature usage, conversion funnel.
    - [ ] Real-time dashboard is created showing system health and key metrics (Grafana or custom).
    - [ ] Workspace-scoped analytics API endpoints are implemented for customer-facing dashboards.
    - [ ] Alerting rules are configured for critical thresholds (high error rate, queue backup, low credits).
    - [ ] Data retention policies are implemented (raw: 7 days, aggregated: 90 days, monthly: 2 years).
    - [ ] Multi-tenant data isolation ensures workspaces can only access their own metrics.
    - [ ] **Tests:** Integration tests verify metric collection and workspace isolation. Load tests confirm metrics system doesn't impact main application performance.
- **Implementation Details:**
    ```typescript
    // Metrics collection service
    interface MetricsService {
      // System metrics
      recordApiRequest(endpoint: string, duration: number, status: number, workspaceId: string): void;
      recordJobProcessing(jobType: string, duration: number, success: boolean, workspaceId: string): void;
      recordQueueDepth(queueName: string, depth: number): void;
      
      // Business metrics
      recordAnalysis(workspaceId: string, websiteId: string, reportType: 'free' | 'detailed'): void;
      recordCreditUsage(workspaceId: string, amount: number, source: 'subscription' | 'purchase'): void;
      recordFeatureUsage(workspaceId: string, feature: string): void;
    }
    
    // Workspace-scoped analytics endpoint
    app.get('/api/workspaces/:id/analytics', authenticate, authorize, async (req, res) => {
      const { id: workspaceId } = req.params;
      const { startDate, endDate, metrics } = req.query;
      
      // Ensure user can only access their workspace's data
      if (!req.user.workspaces.includes(workspaceId)) {
        return res.status(403).json({ error: 'Forbidden' });
      }
      
      const data = await metricsService.getWorkspaceMetrics(
        workspaceId,
        metrics,
        { startDate, endDate }
      );
      
      res.json(data);
    });
    ```
    - Use OpenTelemetry for standardized instrumentation across all services.
    - Implement correlation IDs to trace requests across the entire pipeline.
    - Create custom Grafana dashboards for operations team and workspace-specific views.
    - Use tags/labels for multi-dimensional queries (workspace, plan type, region).
    - Consider using Prometheus for real-time metrics and alerting.
    - Implement cost tracking per workspace to support usage-based billing.
    - Ensure GDPR compliance by anonymizing user data in aggregate metrics.