### **Phase 2: The Modular Analysis Engine**

#### **Issue #2.1c: Enhanced Performance Rules (20+ Rules with Core Web Vitals & UX Metrics)**

- **Problem:** Current performance rules are limited and don't cover the comprehensive performance analysis that affects user experience and search rankings.
- **Goal/Benefit:** To implement 20+ comprehensive performance rules covering Core Web Vitals, loading optimization, and user experience metrics with actionable recommendations and business impact analysis.
- **Acceptance Requirements:**
    - [ ] 20+ performance rules covering Core Web Vitals, loading, rendering, and resource optimization.
    - [ ] Integration with Google Lighthouse API for comprehensive performance auditing.
    - [ ] Business impact assessment for each performance issue (conversion rates, user engagement, SEO rankings).
    - [ ] Technical optimization guidance with specific implementation steps.
    - [ ] Resource loading analysis with waterfall insights.
    - [ ] Mobile and desktop performance differentiation.
    - [ ] Performance budget recommendations and monitoring.

---

## **Comprehensive Performance Rules List**

### **Core Web Vitals (6 rules)**

| rule_key | name | CWV Metric | Impact Level | Business Impact | Mobile/Desktop |
|----------|------|------------|--------------|-----------------|----------------|
| `PERF_CWV_01_LCP_SLOW` | Slow Largest Contentful Paint | LCP | Critical | Conversion Rate | Both |
| `PERF_CWV_02_CLS_HIGH` | High Cumulative Layout Shift | CLS | Critical | User Experience | Both |
| `PERF_CWV_03_FID_SLOW` | Slow First Input Delay | FID | High | User Interaction | Both |
| `PERF_CWV_04_INP_SLOW` | Slow Interaction to Next Paint | INP | High | User Responsiveness | Both |
| `PERF_CWV_05_TTFB_SLOW` | Slow Time to First Byte | TTFB | High | Loading Speed | Both |
| `PERF_CWV_06_FCP_SLOW` | Slow First Contentful Paint | FCP | Medium | Perceived Speed | Both |

### **Resource Loading & Optimization (8 rules)**

| rule_key | name | Impact Level | Primary Benefit | Technical Focus |
|----------|------|--------------|-----------------|-----------------|
| `PERF_RES_01_IMAGE_FORMAT` | Images Not Using Next-Gen Formats | High | File Size Reduction | Image Optimization |
| `PERF_RES_02_IMAGE_DIMENSIONS` | Improperly Sized Images | High | Bandwidth Savings | Image Sizing |
| `PERF_RES_03_IMAGE_LAZY_LOADING` | Images Not Lazy Loaded | Medium | Initial Load Speed | Loading Strategy |
| `PERF_RES_04_UNUSED_CSS` | Unused CSS Code | Medium | Resource Efficiency | CSS Optimization |
| `PERF_RES_05_UNUSED_JS` | Unused JavaScript Code | High | Execution Speed | JS Optimization |
| `PERF_RES_06_RENDER_BLOCKING` | Render-Blocking Resources | Critical | First Paint Speed | Critical Path |
| `PERF_RES_07_FONT_LOADING` | Inefficient Font Loading | Medium | Text Rendering | Font Strategy |
| `PERF_RES_08_THIRD_PARTY_IMPACT` | High Third-Party Impact | High | Overall Performance | External Resources |

### **Caching & Delivery (3 rules)**

| rule_key | name | Impact Level | Primary Benefit | Implementation |
|----------|------|--------------|-----------------|----------------|
| `PERF_CACHE_01_BROWSER_CACHING` | Missing Browser Cache Headers | High | Repeat Visit Speed | HTTP Headers |
| `PERF_CACHE_02_CDN_MISSING` | CDN Not Implemented | Medium | Global Performance | Infrastructure |
| `PERF_CACHE_03_COMPRESSION` | Resource Compression Missing | High | Transfer Speed | Server Config |

### **JavaScript & Interactivity (3 rules)**

| rule_key | name | Impact Level | Primary Benefit | Focus Area |
|----------|------|--------------|-----------------|------------|
| `PERF_JS_01_MAIN_THREAD_BLOCKING` | Main Thread Blocking | Critical | Responsiveness | JS Execution |
| `PERF_JS_02_CODE_SPLITTING` | No Code Splitting | Medium | Initial Load | Bundle Strategy |
| `PERF_JS_03_POLYFILL_BLOAT` | Unnecessary Polyfills | Low | Modern Browsers | Code Efficiency |

---

## **Detailed Rule Specifications**

### **Critical Core Web Vitals Rules**

#### **PERF_CWV_01_LCP_SLOW**
```json
{
  "rule_key": "PERF_CWV_01_LCP_SLOW",
  "name": "Slow Largest Contentful Paint (LCP)",
  "impact_level": "critical",
  "business_risk": "critical",
  "cwv_metric": "LCP",
  "thresholds": {
    "good": "< 2.5s",
    "needs_improvement": "2.5s - 4.0s",
    "poor": "> 4.0s"
  },
  "plain_language_explanation": "The largest visible element on your page takes too long to load, making users wait.",
  "why_it_matters": "LCP directly affects user experience and is a ranking factor for Google search results.",
  "business_impact": "Every 1 second delay in LCP can reduce conversions by 20% and increase bounce rate by 32%.",
  "common_causes": [
    "Large images without optimization",
    "Slow server response times",
    "Render-blocking CSS/JS",
    "Client-side rendering delays"
  ],
  "solutions": [
    {
      "type": "diy",
      "title": "Optimize LCP Element",
      "technical_level": "intermediate",
      "estimated_effort": "medium",
      "steps": [
        "Identify the LCP element using Chrome DevTools",
        "If it's an image, optimize format and size",
        "Preload critical resources with <link rel='preload'>",
        "Optimize server response time (TTFB)",
        "Remove render-blocking resources above the fold"
      ],
      "code_examples": {
        "preload_image": "<link rel='preload' as='image' href='hero-image.webp'>",
        "responsive_images": "<img src='hero.webp' sizes='(max-width: 768px) 100vw, 50vw' loading='eager' alt='Hero image'>"
      }
    },
    {
      "type": "third_party",
      "title": "Performance Optimization Services",
      "tools_mentioned": ["Cloudflare", "CloudFront", "Fastly", "KeyCDN"],
      "description": "CDN services can significantly improve LCP through edge caching and optimization"
    }
  ],
  "testing": {
    "automated_tests": [
      "Lighthouse Performance Audit",
      "PageSpeed Insights",
      "WebPageTest.org"
    ],
    "manual_tests": [
      "Chrome DevTools Performance tab",
      "Network throttling simulation",
      "Real device testing"
    ],
    "validation_criteria": "LCP < 2.5 seconds on both mobile and desktop"
  }
}
```

#### **PERF_CWV_02_CLS_HIGH**
```json
{
  "rule_key": "PERF_CWV_02_CLS_HIGH",
  "name": "High Cumulative Layout Shift (CLS)",
  "impact_level": "critical",
  "business_risk": "critical",
  "cwv_metric": "CLS",
  "thresholds": {
    "good": "< 0.1",
    "needs_improvement": "0.1 - 0.25",
    "poor": "> 0.25"
  },
  "plain_language_explanation": "Elements on your page move around unexpectedly while loading, creating a frustrating user experience.",
  "why_it_matters": "Layout shifts can cause users to accidentally click wrong buttons and create frustration.",
  "business_impact": "High CLS can reduce conversion rates by 15-25% due to accidental clicks and user frustration.",
  "common_causes": [
    "Images without dimensions",
    "Ads and embeds loading asynchronously",
    "Web fonts causing text reflow",
    "Dynamic content insertion"
  ],
  "solutions": [
    {
      "type": "diy",  
      "title": "Prevent Layout Shifts",
      "technical_level": "intermediate",
      "estimated_effort": "medium",
      "steps": [
        "Set explicit width and height on images and videos",
        "Reserve space for ads and dynamic content",
        "Use font-display: swap with font fallbacks",
        "Avoid inserting content above existing content"
      ],
      "code_examples": {
        "image_dimensions": "<img src='image.jpg' width='800' height='600' alt='Descriptive text'>",
        "font_display": "@font-face { font-family: 'CustomFont'; font-display: swap; }",
        "aspect_ratio": ".image-container { aspect-ratio: 16/9; }"
      }
    }
  ],
  "testing": {
    "automated_tests": ["Lighthouse CLS audit", "Web Vitals Chrome extension"],
    "manual_tests": ["Visual layout shift debugging in DevTools"],
    "validation_criteria": "CLS score < 0.1 across all page loads"
  }
}
```

### **Resource Optimization Rules**

#### **PERF_RES_01_IMAGE_FORMAT**
```json
{
  "rule_key": "PERF_RES_01_IMAGE_FORMAT",
  "name": "Images Not Using Next-Gen Formats",
  "impact_level": "high",
  "business_risk": "medium",
  "plain_language_explanation": "Your images use old formats that create larger file sizes and slower loading.",
  "why_it_matters": "Modern image formats like WebP and AVIF can reduce file sizes by 25-50% without quality loss.",
  "business_impact": "Image optimization can improve page load times by 20-30%, directly affecting user engagement.",
  "format_recommendations": {
    "best": "AVIF (90% smaller than JPEG)",
    "good": "WebP (25-50% smaller than JPEG/PNG)",
    "fallback": "Optimized JPEG/PNG"
  },
  "browser_support": {
    "avif": "Chrome 85+, Firefox 93+",
    "webp": "Chrome 23+, Firefox 65+, Safari 14+"
  },
  "solutions": [
    {
      "type": "diy",
      "title": "Implement Next-Gen Image Formats",
      "technical_level": "intermediate",
      "estimated_effort": "medium",
      "steps": [
        "Convert images to WebP/AVIF format",
        "Implement progressive enhancement with <picture> element",
        "Set up automatic conversion in build process",
        "Configure server to serve appropriate format based on browser support"
      ],
      "code_examples": {
        "picture_element": `<picture>
  <source srcset="image.avif" type="image/avif">
  <source srcset="image.webp" type="image/webp">
  <img src="image.jpg" alt="Description" loading="lazy">
</picture>`,
        "responsive_images": "<img srcset='image-320.webp 320w, image-640.webp 640w, image-1024.webp 1024w' sizes='(max-width: 768px) 100vw, 50vw' src='image.jpg' alt='Description'>"
      }
    },
    {
      "type": "third_party",
      "title": "Automated Image Optimization",
      "tools_mentioned": ["Cloudinary", "ImageOptim", "TinyPNG", "Squoosh"],
      "description": "Services that automatically convert and optimize images to best formats"
    }
  ],
  "testing": {
    "automated_tests": ["Lighthouse 'Serve images in next-gen formats' audit"],
    "manual_tests": ["Check network tab for image formats and sizes"],
    "validation_criteria": "All images served in WebP or AVIF with fallbacks"
  }
}
```

---

## **Implementation Strategy**

### **Performance Impact Scoring**

```typescript
interface PerformanceImpact {
  loadTimeImprovement: number; // seconds saved
  bandwidthSavings: number; // percentage reduction
  userExperienceScore: number; // 1-10 scale
  conversionImpact: number; // percentage change
  seoRankingFactor: 'primary' | 'secondary' | 'minor';
  implementationComplexity: 'low' | 'medium' | 'high';
}
```

### **Performance Budget Integration**

```typescript
interface PerformanceBudget {
  metrics: {
    lcp: { target: 2500, warning: 2000 }; // milliseconds
    cls: { target: 0.1, warning: 0.05 };
    fid: { target: 100, warning: 50 }; // milliseconds
  };
  resources: {
    totalSize: { target: 1500, warning: 1200 }; // KB
    imageSize: { target: 800, warning: 600 }; // KB
    jsSize: { target: 400, warning: 300 }; // KB
    cssSize: { target: 100, warning: 80 }; // KB
  };
}
```

### **Monitoring and Alerting**

```typescript
export class PerformanceMonitor {
  async analyzePerformance(url: string): Promise<PerformanceIssue[]> {
    const lighthouseResults = await this.runLighthouseAudit(url);
    const issues: PerformanceIssue[] = [];
    
    // Core Web Vitals analysis
    if (lighthouseResults.lcp > 2500) {
      issues.push(this.createIssue('PERF_CWV_01_LCP_SLOW', {
        currentValue: lighthouseResults.lcp,
        targetValue: 2500,
        recommendations: this.getLCPOptimizations(lighthouseResults)
      }));
    }
    
    // Resource analysis
    const unoptimizedImages = this.analyzeImageOptimization(lighthouseResults);
    if (unoptimizedImages.length > 0) {
      issues.push(this.createIssue('PERF_RES_01_IMAGE_FORMAT', {
        affectedImages: unoptimizedImages,
        potentialSavings: this.calculateImageSavings(unoptimizedImages)
      }));
    }
    
    return issues;
  }
  
  private calculateBusinessImpact(issue: PerformanceIssue): BusinessImpact {
    // Calculate conversion rate impact based on performance metrics
    const loadTimeImpact = this.calculateLoadTimeImpact(issue);
    const conversionImpact = loadTimeImpact * 0.2; // 20% conversion loss per second
    
    return {
      conversionRateChange: -conversionImpact,
      bounceRateChange: loadTimeImpact * 0.32, // 32% bounce rate increase per second
      seoImpact: this.calculateSEOImpact(issue),
      revenueImpact: this.estimateRevenueImpact(conversionImpact)
    };
  }
}
```

### **Progressive Enhancement Strategy**

```typescript
interface OptimizationStrategy {
  immediate: string[]; // Quick wins, low effort
  shortTerm: string[]; // Medium effort, high impact
  longTerm: string[]; // High effort, transformational
  monitoring: string[]; // Ongoing optimization
}
```

This comprehensive performance rules implementation provides enterprise-level performance analysis that helps users understand the business impact of performance issues and provides clear, prioritized optimization strategies.